df_elg %>%
dplyr::select(cond,radchange) %>%
ggplot(aes(x = cond,y = radchange,fill = cond)) +
scale_color_manual(values = c("darkred",
"darkblue",
"darkgreen")) +
scale_fill_manual(values = c("darkred",
"darkblue",
"darkgreen")) +
geom_violinhalf(position = position_nudge(0.1),
#fill = "gray23",
alpha = 0.8,
size = 1,
color = NA) +
# geom_jitter(alpha = 0.6,
#            size = 1,
#            position = position_jitter(0.15)) +
stat_summary(fun.data = "mean_cl_boot",
size = 0.8,
geom = "errorbar",
width = 0.05,
color = "grey50",
position = position_dodge(width = 0)) +
# stat_summary(fun = "mean",
#              geom = "linerange",
#              color = "black",
#              size = 3,
#              position = position_dodge(width = 0)) +
stat_summary(fun = "mean",
shape = 16,
geom = "point",
size = 1.5,
color = "black",
position = position_dodge(width = 0)) +
scale_x_discrete(expand = c(0.2,0)) +
scale_y_continuous(limits = c(1,7),
breaks = seq(1,7,1)) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
panel.grid.major.y = element_line(color = "grey66",
linetype = "dashed"),
axis.ticks = element_blank(),
axis.line = element_line(color = "grey66"),
axis.text.x = element_text(color = "black",
face = "bold",
size = 12,
hjust = -1),
axis.text.y = element_text(color = "black",
face = "bold",
size = 12),
axis.title.y = element_text(color = "black",
face = "bold",
size = 12),
axis.title.x = element_blank(),
legend.position = "none")
mean_age <- df_elg %>%
summarise(age_mean = round(mean(AGE,na.rm = T),2)) %>%
pull()
library(dplyr)
library(effectsize)
summarize_ab <- function(df, y, cond_var = "cond", a = "brkn", b = "kept") {
dat <- df %>%
filter(.data[[cond_var]] %in% c(a, b)) %>%
mutate(cond = factor(.data[[cond_var]], levels = c(b, a)))
stats <- dat %>%
group_by(cond) %>%
summarise(n = n(),
mean = mean(.data[[y]], na.rm = TRUE),
sd = sd(.data[[y]], na.rm = TRUE),
median = median(.data[[y]], na.rm = TRUE),
.groups = "drop")
tt <- t.test(dat[[y]] ~ dat$cond)
d <- effectsize::cohens_d(dat[[y]] ~ dat$cond)$Cohens_d[1]
pct <- pnorm(d) * 100
list(dat = dat, stats = stats, tt = tt, d = d, pct = pct,
ate = unname(stats$mean[stats$cond == a] - stats$mean[stats$cond == b]))
}
res <- summarize_ab(df_elg, "antiest")
res$stats
res$stats %>%
mutate(mean = round(mean, 2), sd = round(sd, 2)) %>%
select(-median) %>%
rename(N = n, Mean = mean, SD = sd)
res$tt$parameter
res$tt$statistic
res$tt$p.value
res$ate
library(dplyr)
library(effectsize)
summarize_ab <- function(df, y, cond_var = "cond", a = "kept", b = "brkn") {
dat <- df %>%
filter(.data[[cond_var]] %in% c(a, b)) %>%
mutate(cond = factor(.data[[cond_var]], levels = c(b, a)))
stats <- dat %>%
group_by(cond) %>%
summarise(n = n(),
mean = mean(.data[[y]], na.rm = TRUE),
sd = sd(.data[[y]], na.rm = TRUE),
median = median(.data[[y]], na.rm = TRUE),
.groups = "drop")
tt <- t.test(dat[[y]] ~ dat$cond)
d <- effectsize::cohens_d(dat[[y]] ~ dat$cond)$Cohens_d[1]
pct <- pnorm(d) * 100
list(dat = dat, stats = stats, tt = tt, d = d, pct = pct,
ate = unname(stats$mean[stats$cond == a] - stats$mean[stats$cond == b]))
}
res <- summarize_ab(df_elg, "antiest")
res$tt$statistic
plot_ab_panel <- function(
df,
outcomes = list(
list(var = "antiest",   label = "Anti-Establishment\nSentiment"),
list(var = "trustgov",  label = "Trust in\nGovernment"),
list(var = "radchange", label = "Support for\nRadical Change")
),
cond_var = "cond",
treat = "brkn",
control = "kept",
cond_labels = c(brkn = "Promise\nBroken", kept = "Promise\nKept"),
y_limits = c(1, 7),
y_breaks = 1:7,
treat_fill = "darkred",
control_fill = "darkgreen",
caption = "Distributions are shown as half-violins. Black points indicate group means; vertical bars show bootstrapped 95% confidence intervals. All panels share the same 1–7 scale to make effect sizes comparable across outcomes."
) {
stopifnot(requireNamespace("ggplot2", quietly = TRUE))
stopifnot(requireNamespace("dplyr", quietly = TRUE))
stopifnot(requireNamespace("patchwork", quietly = TRUE))
stopifnot(requireNamespace("see", quietly = TRUE))
make_one <- function(y, ylab) {
df %>%
dplyr::filter(.data[[cond_var]] %in% c(control, treat)) %>%
dplyr::mutate(
cond_plot = dplyr::case_when(
.data[[cond_var]] == treat   ~ cond_labels[[treat]],
.data[[cond_var]] == control ~ cond_labels[[control]],
TRUE ~ NA_character_
),
cond_plot = factor(cond_plot, levels = c(cond_labels[[treat]], cond_labels[[control]]))
) %>%
ggplot2::ggplot(ggplot2::aes(x = cond_plot, y = .data[[y]], fill = cond_plot)) +
ggplot2::scale_fill_manual(values = c(cond_labels[[treat]] = treat_fill,
plot_ab_panel <- function(
df,
outcomes = list(
list(var = "antiest",   label = "Anti-Establishment\nSentiment"),
list(var = "trustgov",  label = "Trust in\nGovernment"),
list(var = "radchange", label = "Support for\nRadical Change")
),
cond_var = "cond",
treat = "brkn",
control = "kept",
cond_labels = c(brkn = "Promise\nBroken", kept = "Promise\nKept"),
y_limits = c(1, 7),
y_breaks = 1:7,
treat_fill = "darkred",
control_fill = "darkgreen",
caption = "Distributions are shown as half-violins. Black points indicate group means; vertical bars show bootstrapped 95% confidence intervals. All panels share the same 1–7 scale to make effect sizes comparable across outcomes."
) {
stopifnot(requireNamespace("ggplot2", quietly = TRUE))
stopifnot(requireNamespace("dplyr", quietly = TRUE))
stopifnot(requireNamespace("patchwork", quietly = TRUE))
stopifnot(requireNamespace("see", quietly = TRUE))
make_one <- function(y, ylab) {
df %>%
filter(.data[[cond_var]] %in% c(control, treat)) %>%
mutate(
cond_plot = dplyr::case_when(
.data[[cond_var]] == treat   ~ cond_labels[[treat]],
.data[[cond_var]] == control ~ cond_labels[[control]],
TRUE ~ NA_character_
),
cond_plot = factor(cond_plot, levels = c(cond_labels[[treat]], cond_labels[[control]]))
) %>%
ggplot(ggplot2::aes(x = cond_plot, y = .data[[y]], fill = cond_plot)) +
scale_fill_manual(values = c(cond_labels[[treat]] = treat_fill,
f_innerplot <- function(data,outcome,ylabel){df %>%
filter(cond != "ctrl") %>%
dplyr::select(cond,outcome) %>%
mutate(cond = case_when(cond == "brkn" ~ "Promise\nBroken",
cond == "kept" ~ "Promise\nKept",
.default = NA)) %>%
ggplot(aes(x = cond,y = antiest,fill = cond)) +
scale_color_manual(values = c("darkred",
"darkgreen")) +
scale_fill_manual(values = c("darkred",
"darkgreen")) +
geom_violinhalf(position = position_nudge(0),
side = "l",
alpha = 0.3,
size = 1,
color = NA) +
stat_summary(fun.data = "mean_cl_boot",
size = 0.5,
geom = "errorbar",
width = 0.05,
color = "black",
position = position_dodge(width = 0)) +
stat_summary(fun = "mean",
shape = 16,
geom = "point",
size = 1.8,
color = "black",
position = position_dodge(width = 0)) +
scale_x_discrete(expand = c(0.2,0)) +
scale_y_continuous(limits = c(1,7),
breaks = seq(1,7,1)) +
ylab(ylabel) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
panel.grid.major.y = element_line(color = "grey66",
linetype = "dashed"),
axis.ticks = element_blank(),
axis.line = element_line(color = "grey66"),
axis.text.x = element_text(color = "black",
face = "bold",
size = 14,
hjust = 0.5,
vjust = 1),
axis.text.y = element_text(color = "black",
face = "bold",
size = 11),
axis.title.y = element_text(color = "black",
face = "bold",
size = 14),
axis.title.x = element_blank(),
legend.position = "none")}
f_innerplot(df_elg,antiest,"Anti-Establishment\nSentiment")
f_innerplot(df_elg,outcome = "antiest","Anti-Establishment\nSentiment")
f_innerplot(df_elg,"antiest","Anti-Establishment\nSentiment")
p1 <- f_innerplot(df_elg,"antiest","Anti-Establishment\nSentiment")
p2 <- f_innerplot(df_elg,"trustgov","Trust in\nGovernment")
p3 <- f_innerplot(df_elg,"radchange","Support for\nRadical Change")
grid.arrange(p1,p2,p3,nrow = 1)
p1
p1 <- f_innerplot(df_elg,"antiest","Anti-Establishment\nSentiment")
p1
grid.arrange(p1,p2,p3,nrow = 1)
f_innerplot <- function(data,outcome,ylabel){df %>%
filter(cond != "ctrl") %>%
dplyr::select(cond,outcome) %>%
mutate(cond = case_when(cond == "brkn" ~ "Promise\nBroken",
cond == "kept" ~ "Promise\nKept",
.default = NA)) %>%
ggplot(aes(x = cond,y = .data[[outcome]],fill = cond)) +
scale_color_manual(values = c("darkred",
"darkgreen")) +
scale_fill_manual(values = c("darkred",
"darkgreen")) +
geom_violinhalf(position = position_nudge(0),
side = "l",
alpha = 0.3,
size = 1,
color = NA) +
stat_summary(fun.data = "mean_cl_boot",
size = 0.5,
geom = "errorbar",
width = 0.05,
color = "black",
position = position_dodge(width = 0)) +
stat_summary(fun = "mean",
shape = 16,
geom = "point",
size = 1.8,
color = "black",
position = position_dodge(width = 0)) +
scale_x_discrete(expand = c(0.2,0)) +
scale_y_continuous(limits = c(1,7),
breaks = seq(1,7,1)) +
ylab(ylabel) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
panel.grid.major.y = element_line(color = "grey66",
linetype = "dashed"),
axis.ticks = element_blank(),
axis.line = element_line(color = "grey66"),
axis.text.x = element_text(color = "black",
face = "bold",
size = 14,
hjust = 0.5,
vjust = 1),
axis.text.y = element_text(color = "black",
face = "bold",
size = 11),
axis.title.y = element_text(color = "black",
face = "bold",
size = 14),
axis.title.x = element_blank(),
legend.position = "none")}
p1 <- f_innerplot(df_elg,"antiest","Anti-Establishment\nSentiment")
p2 <- f_innerplot(df_elg,"trustgov","Trust in\nGovernment")
p3 <- f_innerplot(df_elg,"radchange","Support for\nRadical Change")
grid.arrange(p1,p2,p3,nrow = 1)
directionality_anova <- function(data, y, cond_var = "cond",
levels = c("kept", "ctrl", "brkn")) {
dat <- data %>%
dplyr::filter(.data[[cond_var]] %in% levels) %>%
dplyr::mutate(cond = factor(.data[[cond_var]], levels = levels))
stats <- dat %>%
dplyr::group_by(cond) %>%
dplyr::summarise(
N = dplyr::n(),
Mean = mean(.data[[y]], na.rm = TRUE),
SD = sd(.data[[y]], na.rm = TRUE),
.groups = "drop"
)
aov_fit <- stats::aov(stats::as.formula(paste0(y, " ~ cond")), data = dat)
tuk <- stats::TukeyHSD(aov_fit)$cond %>%
as.data.frame() %>%
tibble::rownames_to_column("comparison") %>%
dplyr::rename(diff = diff, lwr = lwr, upr = upr, p_adj = `p adj`)
# Pull the specific comparisons (names depend on factor level order)
pull_cmp <- function(name) tuk %>% dplyr::filter(comparison == name) %>% dplyr::slice(1)
brkn_kept <- pull_cmp("brkn-kept")
brkn_ctrl <- pull_cmp("brkn-ctrl")
ctrl_kept <- pull_cmp("ctrl-kept")
# Interpretation (very lightweight + consistent)
interpret <- dplyr::case_when(
brkn_ctrl$p_adj < .05 & ctrl_kept$p_adj >= .05 ~
"Pattern is consistent with the *Broken* prompt shifting outcomes away from baseline (Control), while the *Kept* prompt does not differ from baseline.",
ctrl_kept$p_adj < .05 & brkn_ctrl$p_adj >= .05 ~
"Pattern is consistent with the *Kept* prompt shifting outcomes away from baseline (Control), while the *Broken* prompt does not differ from baseline.",
brkn_ctrl$p_adj < .05 & ctrl_kept$p_adj < .05 ~
"Both experimental prompts differ from baseline (Control), suggesting the effect may be driven by both directions.",
TRUE ~
"Pairwise differences are not conclusive after Tukey adjustment; directionality is ambiguous in this outcome."
)
list(
dat = dat,
stats = stats,
aov = aov_fit,
tukey = tuk,
brkn_kept = brkn_kept,
brkn_ctrl = brkn_ctrl,
ctrl_kept = ctrl_kept,
interpretation = interpret
)
}
res_dir <- directionality_anova(df_elg, "antiest")
res_dir$stats %>%
dplyr::mutate(
Mean = round(Mean, 2),
SD = round(SD, 2)
) %>%
knitr::kable() %>%
kableExtra::kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "left")
res_dir$tukey %>%
dplyr::mutate(
diff = round(diff, 2),
lwr  = round(lwr, 2),
upr  = round(upr, 2),
p_adj = ifelse(p_adj < .001, "< .001", round(p_adj, 3))
)
detachAllPackages <- function() {
basic.packages <- c("package:stats","package:graphics","package:grDevices","package:utils","package:datasets","package:methods","package:base")
package.list <- search()[ifelse(unlist(gregexpr("package:",search()))==1,TRUE,FALSE)]
package.list <- setdiff(package.list,basic.packages)
if (length(package.list)>0)  for (package in package.list) detach(package, character.only=TRUE)
}
detachAllPackages()
library(tidyverse)
library(stringr)
library(see)
library(gridExtra)
library(tidytext)
library(apa)
library(kableExtra)
library(papaja)
library(effectsize)
base_url <- "https://raw.githubusercontent.com/deanbaltiansky/ab-testing-social-contract/main/data/"
file <- "bsc_experiment_clean.csv"
df <- readr::read_csv(file.path(base_url, file))
df_elg <- df %>%
filter(exclude == 0)
total_n <- nrow(df)
eligible_n = nrow(df_elg)
mean_age <- df_elg %>%
summarise(age_mean = round(mean(AGE,na.rm = T),2)) %>%
pull()
n_white <- df_elg %>%
group_by(RACETHNICITY) %>%
summarise(N = n()) %>%
ungroup() %>%
filter(RACETHNICITY == "white/non-hisp") %>%
select(N) %>%
pull()
n_man <- df_elg %>%
group_by(GENDER) %>%
summarise(N = n()) %>%
ungroup() %>%
filter(GENDER == "male") %>%
select(N) %>%
pull()
income_brackets = c("under $5,000",
"$5,000 to $9,999",
"$10,000 to $14,999",
"$15,000 to $19,999",
"$20,000 to $24,999",
"$25,000 to $29,999",
"$30,000 to $34,999",
"$35,000 to $39,999",
"$40,000 to $49,999",
"$50,000 to $59,999",
"$60,000 to $74,999",
"$75,000 to $84,999",
"$85,000 to $99,999",
"$100,000 to $124,999",
"$125,000 to $149,999",
"$150,000 to $174,999",
"$175,000 to $199,999",
"$200,000 or more")
df_incomes <- tibble(bracket = income_brackets,
income_num = seq(1,length(income_brackets),1))
median_income <- df_elg %>%
mutate(income = factor(INCOME,income_brackets),
income_num = as.numeric(income)) %>%
summarise(median = median(income_num,na.rm = T)) %>%
left_join(df_incomes %>% rename(median = income_num),by = "median") %>%
select(bracket) %>%
pull()
summarize_ab <- function(data, y, cond_var = "cond", treat = "brkn", control = "kept") {
dat <- data %>%
filter(.data[[cond_var]] %in% c(control, treat)) %>%
mutate(cond = factor(.data[[cond_var]], levels = c(control, treat)))
stats <- dat %>%
group_by(cond) %>%
summarise(
n      = n(),
mean   = mean(.data[[y]], na.rm = TRUE),
sd     = sd(.data[[y]], na.rm = TRUE),
median = median(.data[[y]], na.rm = TRUE),
.groups = "drop"
)
ate <- stats %>%
summarise(ate = mean[cond == treat] - mean[cond == control]) %>%
pull(ate)
# t-test in treat - control direction
tt <- t.test(
x = dat %>% filter(cond == treat) %>% pull(.data[[y]]),
y = dat %>% filter(cond == control) %>% pull(.data[[y]])
)
ci <- tt$conf.int
d <- effectsize::cohens_d(
x = dat %>% filter(cond == treat) %>% pull(.data[[y]]),
y = dat %>% filter(cond == control) %>% pull(.data[[y]])
) %>% pull(Cohens_d)
pct <- pnorm(d) * 100
list(dat = dat, stats = stats, tt = tt, d = d, pct = pct, ate = ate, ci = ci,
treat = treat, control = control)
}
f_innerplot <- function(data,outcome,ylabel){data %>%
filter(cond != "ctrl") %>%
mutate(cond = case_when(cond == "brkn" ~ "Promise\nBroken",
cond == "kept" ~ "Promise\nKept",
.default = NA)) %>%
ggplot(aes(x = cond,y = .data[[outcome]],fill = cond)) +
scale_color_manual(values = c("darkred",
"darkgreen")) +
scale_fill_manual(values = c("darkred",
"darkgreen")) +
geom_violinhalf(position = position_nudge(0),
side = "l",
alpha = 0.3,
size = 1,
color = NA) +
stat_summary(fun.data = "mean_cl_boot",
size = 0.5,
geom = "errorbar",
width = 0.05,
color = "black",
position = position_dodge(width = 0)) +
stat_summary(fun = "mean",
shape = 16,
geom = "point",
size = 1.8,
color = "black",
position = position_dodge(width = 0)) +
scale_x_discrete(expand = c(0.2,0)) +
scale_y_continuous(limits = c(1,7),
breaks = seq(1,7,1)) +
ylab(ylabel) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
panel.grid.major.y = element_line(color = "grey66",
linetype = "dashed"),
axis.ticks = element_blank(),
axis.line = element_line(color = "grey66"),
axis.text.x = element_text(color = "black",
face = "bold",
size = 14,
hjust = 0.5,
vjust = 1),
axis.text.y = element_text(color = "black",
face = "bold",
size = 11),
axis.title.y = element_text(color = "black",
face = "bold",
size = 14),
axis.title.x = element_blank(),
legend.position = "none")}
png("treatment_effect.png",width = 500,height = 200,units = "px")
grid.arrange(p1,p2,p3,nrow = 1)
600*0.4
png("treatment_effect.png",width = 600,height = 240,units = "px")
grid.arrange(p1,p2,p3,nrow = 1)
700*0.4
png("treatment_effect.png",width = 700,height = 280,units = "px")
grid.arrange(p1,p2,p3,nrow = 1)
